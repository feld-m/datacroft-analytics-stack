version: "3.9"

services:
  postgres-warehouse:
    image: "postgres:15.0-bullseye"
    container_name: postgres-warehouse
    restart: always
    ports:
      - "5432:5432"
    env_file:
      - ./postgres/config/.env-postgres
    volumes:
      - warehouse-volume:/var/lib/postgresql/data

  dbt:
    image: "ghcr.io/dbt-labs/dbt-postgres:1.3.latest"
    container_name: dbt
    restart: always
    volumes:
      - .:/usr/app
      - ./dbt/config/profiles.yml:/root/.dbt/profiles.yml
    command: [ "init", "analytics" ]
    depends_on:
      - postgres-warehouse

  metabase-db:
    image: "postgres:15.0-bullseye"
    container_name: metabase-db
    restart: always
    ports:
      - "5433:5432"
    env_file:
      - ./metabase/config/.env-metabase-db
    volumes:
      - metabase-db-volume:/var/lib/postgresql/data

  metabase:
    image: "metabase/metabase:v0.44.5"
    container_name: metabase
    restart: always
    ports:
      - "3000:3000"
    env_file:
      - ./metabase/config/.env-metabase-db


volumes:
  warehouse-volume:
  metabase-db-volume:
